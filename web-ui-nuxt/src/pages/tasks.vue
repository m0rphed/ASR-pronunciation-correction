<script setup lang="ts">
import type { Database } from '~~/types/database.types'

const client = useSupabaseClient<Database>()
const user = useSupabaseUser()

const tasksFromServer = ref()
const isModalOpen = ref(false)
const loading = ref(false)
const newTask = ref('')

const { data: tasks } = await useAsyncData('tasks', async () => {
    const { data } = await client.from('tasks').select('id, title, completed').eq('user', user.value.id).order('created_at')

    return data
})

async function addTask() {
    if (newTask.value.trim().length === 0) return

    loading.value = true

    const { data } = await client.from('tasks')
        .upsert({
            user: user.value.id,
            title: newTask.value,
            completed: false,
        })
        .select('id, title, completed')
        .single()

    tasks.value.push(data)
    newTask.value = ''
    loading.value = false
}

const completeTask = async (task: Task) => {
    await client.from('tasks').update({ completed: task.completed }).match({ id: task.id })
}

const removeTask = async (task: Task) => {
    tasks.value = tasks.value.filter(t => t.id !== task.id)
    await client.from('tasks').delete().match({ id: task.id })
}

const fetchTasksFromServerRoute = async () => {
    const { data } = await useFetch('/backend/tasks', { headers: useRequestHeaders(['cookie']), key: 'task-from-server' })

    tasksFromServer.value = data
    isModalOpen.value = true
}

const fetchTextFromServerRoute = async () => {
    const { data } = await useFetch('/backend/text_data', { headers: useRequestHeaders(['cookie']), key: 'text-from-server' })

    tasksFromServer.value = data
    isModalOpen.value = true
}

const generateTask = async () => {
    try {
        const response = await fetch('http://localhost:3000/api/new');
        const data = await response.json();
        tasksFromServer.value = data;
        isModalOpen.value = true;
    } catch (error) {
        console.error('Ошибка при получении данных:', error);
    }
}
</script>

<template>
    <div class="w-full my-[50px]">
        <h1 class="mb-12 text-6xl font-bold">
            Все задачи
        </h1>
        <UButton class="mt-6" label="Generate" @click="generateTask" />
        <form class="flex gap-2 my-2" @submit.prevent="addTask">
            <UInput v-model="newTask" :loading="loading" class="w-full" size="xl" variant="outline" type="text"
                name="newTask" placeholder="Make a coffee" autofocus autocomplete="off" />
            <UButton type="submit" variant="outline">
                Add
            </UButton>
        </form>
        <UCard v-if="tasks?.length > 0" class="px-6 py-2 overflow-hidden">
            <ul>
                <li v-for="task of tasks" :key="task.id" class="border-b border-gray-200 divide-y divide-gray-200">
                    <div class="py-2">
                        <UFormGroup
                            :label-class="`block font-medium ${task.completed ? 'line-through u-text-gray-500' : 'u-text-gray-700'}`"
                            :label="task.title" :name="String(task.id)"
                            class="flex items-center justify-between w-full">
                            <div class="flex items-center justify-between">
                                <div @click="completeTask(task)">
                                    <UToggle v-model="task.completed" :name="String(task.id)"
                                        icon-off="heroicons-solid:x" icon-on="heroicons-solid:check" />
                                </div>
                                <UButton class="ml-3 text-red-600" size="sm" color="red" variant="ghost"
                                    icon="i-heroicons-outline-trash" @click="removeTask(task)" />
                            </div>
                        </UFormGroup>
                    </div>
                </li>
            </ul>
        </UCard>
        <UButton class="mt-6" label="Fetch tasks from Nuxt server route" @click="fetchTasksFromServerRoute" />
        <div/>
        <UButton class="mt-6" label="Fetch text from Nuxt server route" @click="fetchTextFromServerRoute" />
        <UModal v-model="isModalOpen">
            <UCard>
                <h2 class="mb-4">
                    Tasks fetched from
                    <a href="https://nuxt.com/docs/guide/directory-structure/server" target="_blank"
                        class="text-primary-500 underline">Nuxt Server route</a>
                    with the use of the
                    <a href="https://supabase.nuxtjs.org/usage/services/serversupabaseclient" target="_blank"
                        class="text-primary-500 underline">serverSupabaseClient</a>:
                </h2>
                <pre>
          {{ tasksFromServer }}
        </pre>
            </UCard>
        </UModal>
    </div>
</template>

<style lang="postcss">
ul>li:last-child {
    @apply border-b-0;
}
</style>
